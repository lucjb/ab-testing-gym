<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A/B Testing Gym</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.4/jstat.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="challenge-generator.js" defer></script>
</head>
<body class="bg-gray-50 text-gray-900">
    <div class="max-w-5xl mx-auto p-8">
        <h1 class="text-4xl font-bold text-center text-blue-600 mb-6">A/B Testing Gym</h1>
        <p class="text-lg text-center text-gray-700 mb-6">Analyze A/B tests like a pro! Make data-driven decisions and track your score.</p>
        
        <div class="flex justify-between items-center mb-6">
            <p class="text-xl font-semibold">Score: <span id="score" class="text-blue-600">0</span></p>
            <button id="start-btn" class="px-6 py-2 bg-blue-500 text-white font-bold rounded-lg shadow hover:bg-blue-600 transition">Start</button>
        </div>
        
        <div id="challenge-container" class="hidden mt-8 p-6 bg-white rounded-lg shadow-lg border border-gray-300">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Experiment Design</h2>
            <table class="w-full border-collapse border border-gray-300 mb-4 bg-gray-50">
                <tbody id="experiment-card" class="text-gray-700"></tbody>
            </table>

            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Experiment Results</h2>
            <table class="w-full border-collapse border border-gray-300 mb-4 bg-gray-50">
                <tbody id="result-card" class="text-gray-700"></tbody>
            </table>

            <canvas id="conversion-chart" class="mt-6"></canvas>

            <h2 class="text-xl font-semibold text-center mt-6">Decision Time</h2>
            <p class="text-center text-gray-700 mb-4">Based on these results, should we conclude that Variant B is better than A?</p>
            <div class="flex justify-center space-x-4">
                <button id="decision-yes" class="px-6 py-3 bg-green-500 text-white rounded-lg shadow hover:bg-green-600 transition">Yes</button>
                <button id="decision-no" class="px-6 py-3 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 transition">No</button>
            </div>
        </div>

        <div id="feedback" class="hidden mt-4 p-4 text-center font-semibold text-lg"></div>
        <div class="flex justify-center mt-4">
            <button id="next-btn" class="hidden px-6 py-3 bg-blue-500 text-white font-bold rounded-lg shadow hover:bg-blue-600 transition">Next Challenge</button>
        </div>
    </div>
    
    <script>
        let score = 0;
        let challenge = null;

        document.getElementById('start-btn').addEventListener('click', function(event) {
            event.preventDefault();
            document.getElementById('challenge-container').classList.remove('hidden');
            document.getElementById('start-btn').classList.add('hidden');
            loadChallenge();
        });

        document.getElementById('decision-yes').addEventListener('click', function() {
            evaluateDecision(true);
        });
        
        document.getElementById('decision-no').addEventListener('click', function() {
            evaluateDecision(false);
        });
        
        document.getElementById('next-btn').addEventListener('click', function() {
            loadChallenge();
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('next-btn').classList.add('hidden');
        });
        
        function loadChallenge() {
            if (typeof generateABTestChallenge !== 'function') {
                console.error("generateABTestChallenge function is not defined. Check challenge-generator.js.");
                alert("Error: Challenge generator not found. Please check challenge-generator.js.");
                return;
            }
            
            challenge = generateABTestChallenge();
            document.getElementById('experiment-card').innerHTML = `
                <tr><td class='border px-4 py-2'>Alpha:</td><td class='border px-4 py-2'>${challenge.experiment.alpha}</td></tr>
                <tr><td class='border px-4 py-2'>Beta:</td><td class='border px-4 py-2'>${challenge.experiment.beta}</td></tr>
                <tr><td class='border px-4 py-2'>Base Conversion Rate:</td><td class='border px-4 py-2'>${challenge.experiment.baseConversionRate}</td></tr>
                <tr><td class='border px-4 py-2'>Minimum Relevant Effect:</td><td class='border px-4 py-2'>${challenge.experiment.minimumRelevantEffect}</td></tr>
                <tr><td class='border px-4 py-2'>Visitors per Day:</td><td class='border px-4 py-2'>${challenge.experiment.visitorsPerDay}</td></tr>
                <tr><td class='border px-4 py-2'>Business Cycle Days:</td><td class='border px-4 py-2'>${challenge.experiment.businessCycleDays}</td></tr>
            `;
            document.getElementById('result-card').innerHTML = `
                <h3 class='text-xl font-semibold mt-4 mb-2'>Conversion Performance</h3>
                <table class='w-full border-collapse border border-gray-300 mb-4 bg-gray-50'>
                    <thead>
                        <tr class='bg-gray-200'>
                            <th class='border px-4 py-2'>Metric</th>
                            <th class='border px-4 py-2'>Base</th>
                            <th class='border px-4 py-2'>Variant</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td class='border px-4 py-2'>Conversion Rate</td><td class='border px-4 py-2'>${challenge.simulation.actualBaseConversionRate.toFixed(4)}</td><td class='border px-4 py-2'>${challenge.simulation.variantConversionRate.toFixed(4)}</td></tr>
                        <tr><td class='border px-4 py-2'>Total Visitors</td><td class='border px-4 py-2'>${challenge.simulation.actualVisitorsBase}</td><td class='border px-4 py-2'>${challenge.simulation.actualVisitorsVariant}</td></tr>
                        <tr><td class='border px-4 py-2'>Total Conversions</td><td class='border px-4 py-2'>${challenge.simulation.actualConversionsBase}</td><td class='border px-4 py-2'>${challenge.simulation.actualConversionsVariant}</td></tr>
                    </tbody>
                </table>
                
                <h3 class='text-xl font-semibold mt-4 mb-2'>Confidence Intervals</h3>
                
                <div class='mb-4'>
                    <p class='font-semibold mb-1'>Base Conversion Rate CI:</p>
                    <div class='relative w-full bg-gray-200 rounded-full h-2.5'>
                        <div class='absolute text-xs bottom-[-20px] left-0' style='left: ${(challenge.simulation.confidenceIntervalBase[0] * 100).toFixed(1)}%;'>${challenge.simulation.confidenceIntervalBase[0].toFixed(4)}</div>
                        <div class='absolute text-xs bottom-[-20px] right-0' style='right: ${(100 - challenge.simulation.confidenceIntervalBase[1] * 100).toFixed(1)}%;'>${challenge.simulation.confidenceIntervalBase[1].toFixed(4)}</div>
                        <div class='bg-blue-500 h-2.5 rounded-full' style='position: absolute; left:${(challenge.simulation.confidenceIntervalBase[0] * 100).toFixed(1)}%; width:${((challenge.simulation.confidenceIntervalBase[1] - challenge.simulation.confidenceIntervalBase[0]) * 100).toFixed(1)}%;'></div>
                    </div>
                </div>
                
                <div class='mb-4'>
                    <p class='font-semibold mb-1'>Variant Conversion Rate CI:</p>
                    <div class='relative w-full bg-gray-200 rounded-full h-2.5'>
                        <div class='absolute text-xs bottom-[-20px] left-0' style='left: ${(challenge.simulation.confidenceIntervalVariant[0] * 100).toFixed(1)}%;'>${challenge.simulation.confidenceIntervalVariant[0].toFixed(4)}</div>
                        <div class='absolute text-xs bottom-[-20px] right-0' style='right: ${(100 - challenge.simulation.confidenceIntervalVariant[1] * 100).toFixed(1)}%;'>${challenge.simulation.confidenceIntervalVariant[1].toFixed(4)}</div>
                        <div class='bg-green-500 h-2.5 rounded-full' style='position: absolute; left:${(challenge.simulation.confidenceIntervalVariant[0] * 100).toFixed(1)}%; width:${((challenge.simulation.confidenceIntervalVariant[1] - challenge.simulation.confidenceIntervalVariant[0]) * 100).toFixed(1)}%;'></div>
                    </div>
                </div>
                
                <div class='mb-4'>
                    <p class='font-semibold mb-1'>Difference in Conversion Rate CI:</p>
                    <div class='relative w-full bg-gray-200 rounded-full h-2.5'>
                        <div class='absolute text-xs bottom-[-20px] left-0' style='left: ${(challenge.simulation.confidenceIntervalDifference[0] * 100).toFixed(1)}%;'>${challenge.simulation.confidenceIntervalDifference[0].toFixed(4)}</div>
                        <div class='absolute text-xs bottom-[-20px] right-0' style='right: ${(100 - challenge.simulation.confidenceIntervalDifference[1] * 100).toFixed(1)}%;'>${challenge.simulation.confidenceIntervalDifference[1].toFixed(4)}</div>
                        <div class='bg-red-500 h-2.5 rounded-full' style='position: absolute; left:${(challenge.simulation.confidenceIntervalDifference[0] * 100).toFixed(1)}%; width:${((challenge.simulation.confidenceIntervalDifference[1] - challenge.simulation.confidenceIntervalDifference[0]) * 100).toFixed(1)}%;'></div>
                    </div>
                </div>
            `;
            renderChart(challenge.simulation.cumulativeDifferenceConversionRate);
        }

        function evaluateDecision(userChoice) {
            if (!challenge) {
                console.error("No challenge loaded. Cannot evaluate decision.");
                alert("No challenge available. Try reloading.");
                return;
            }
            
            const correctDecision = challenge.simulation.variantConversionRate > challenge.simulation.actualBaseConversionRate;
            if (userChoice === correctDecision) {
                score++;
                document.getElementById('score').textContent = score;
                document.getElementById('feedback').textContent = "✅ Correct! Your score has increased.";
            } else {
                document.getElementById('feedback').textContent = "❌ Incorrect. Review the results carefully.";
            }
            document.getElementById('feedback').classList.remove('hidden');
            document.getElementById('next-btn').classList.remove('hidden');
        }

        function renderChart(data) {
            new Chart(document.getElementById('conversion-chart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.map((_, i) => i + 1),
                    datasets: [{
                        label: 'Cumulative Difference in Conversion Rate',
                        data: data,
                        borderColor: 'blue',
                        fill: false,
                    }]
                },
                options: {
                    responsive: true,
                }
            });
        }
    </script>
</body>
</html>
